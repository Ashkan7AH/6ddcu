const PROXY_SOURCE_URL = "https://raw.githubusercontent.com/ALIILAPRO/MTProtoProxy/main/mtproto.txt";
const CACHE_TTL = 60; // مدت‌زمان کش (۶۰ ثانیه)

// تابع اصلی برای پردازش درخواست
async function handleRequest(event) {
  const cache = caches.default;
    const cacheKey = event.request.url;

      let response = await cache.match(cacheKey);
        if (!response) {
            try {
                  const proxyData = await fetchProxyData();
                        const proxyList = extractProxyLinks(proxyData);
                              const htmlContent = generateHTML(proxyList);

                                    response = new Response(htmlContent, {
                                            headers: { "Content-Type": "text/html; charset=UTF-8" },
                                                  });

                                                        // کش کردن داده‌ها
                                                              event.waitUntil(cache.put(cacheKey, response.clone()));
                                                                  } catch (error) {
                                                                        return new Response("Error: " + error.message, { status: 500 });
                                                                            }
                                                                              }
                                                                                return response;
                                                                                }

                                                                                // دریافت داده از فایل متنی
                                                                                async function fetchProxyData() {
                                                                                  const response = await fetch(PROXY_SOURCE_URL);
                                                                                    if (!response.ok) {
                                                                                        throw new Error("Failed to fetch proxy data.");
                                                                                          }
                                                                                            return await response.text();
                                                                                            }

                                                                                            // استخراج لینک‌های t.me/proxy از فایل متنی
                                                                                            function extractProxyLinks(text) {
                                                                                              const regex = /https:\/\/t\.me\/proxy\?server=.*?&port=.*?&secret=\w+/g;
                                                                                                const links = text.match(regex) || [];
                                                                                                  return [...new Set(links)]; // حذف لینک‌های تکراری
                                                                                                  }

                                                                                                  // تولید صفحه HTML با امکان کپی لینک‌ها و استفاده از فونت چمران
                                                                                                  function generateHTML(proxyList) {
                                                                                                    return `
                                                                                                        <!DOCTYPE html>
                                                                                                            <html lang="fa">
                                                                                                                  <head>
                                                                                                                          <meta charset="UTF-8">
                                                                                                                                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                                                                                                                          <title>Telegram Proxy</title>
                                                                                                                                                  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/chamran-font@v1.0.0/dist/font-face.css" rel="stylesheet" type="text/css" />
                                                                                                                                                          <style>
                                                                                                                                                                    * {
                                                                                                                                                                                margin: 0;
                                                                                                                                                                                            padding: 0;
                                                                                                                                                                                                        box-sizing: border-box;
                                                                                                                                                                                                                    font-family: "Chamran", Arial, sans-serif;
                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                        body {
                                                                                                                                                                                                                                                    background-color: #fdfdfd;
                                                                                                                                                                                                                                                                color: #333;
                                                                                                                                                                                                                                                                            text-align: center;
                                                                                                                                                                                                                                                                                        padding: 20px;
                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                            header {
                                                                                                                                                                                                                                                                                                                        font-size: 2em;
                                                                                                                                                                                                                                                                                                                                    margin-bottom: 10px;
                                                                                                                                                                                                                                                                                                                                                color: #007bff;
                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                    .sub-header {
                                                                                                                                                                                                                                                                                                                                                                                font-size: 0.9em;
                                                                                                                                                                                                                                                                                                                                                                                            margin-bottom: 20px;
                                                                                                                                                                                                                                                                                                                                                                                                        color: #555;
                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                            .proxy-list {
                                                                                                                                                                                                                                                                                                                                                                                                                                        max-width: 600px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                    margin: 0 auto;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                text-align: left;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            direction: ltr;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .proxy-item {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            margin: 10px 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        padding: 8px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    background: #f4f4f4;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                border: 1px solid #ddd;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            border-radius: 8px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        word-wrap: break-word;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor: pointer;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                transition: background-color 0.3s ease;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .proxy-item:hover {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                background-color: #e0e0e0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    footer {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                margin-top: 20px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            font-size: 0.9em;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        color: #777;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </style>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function copyToClipboard(text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        navigator.clipboard.writeText(text).then(() => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      alert("پروکسی کپی شد!");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }).catch(err => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.error("Failed to copy: ", err);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </head>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <header>Telegram Proxy</header>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="sub-header">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    برای اتصال به پروکسی‌ها روی لینک پروکسی کلیک کنید و آن را کپی کنید و داخل سیو مسیج بفرستید و به آن متصل شوید
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="proxy-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ${proxyList
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .map(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (link, index) => `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div class="proxy-item" onclick="copyToClipboard('${link}')">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ${link}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .join("")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <footer>آخرین به‌روزرسانی: ${getIranTime()}</footer>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // تولید زمان به وقت ایران
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            function getIranTime() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const now = new Date();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const utc = now.getTime() + now.getTimezoneOffset() * 60000;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const iranTime = new Date(utc + 3.5 * 3600000);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return iranTime.toLocaleString("fa-IR", { hour12: false });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    addEventListener("fetch", (event) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      event.respondWith(handleRequest(event));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });
